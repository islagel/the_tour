---
title: "le Tour de France"
runtime: shiny
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(maps)
library(plotly)
knitr::opts_chunk$set(echo = TRUE)
top_tens <- as.tibble(readRDS("~/Mscs 264 F18/Submit Section B/TourProject/top_tens.rds"))
doping_tibble <- as.tibble(readRDS("~/Mscs 264 F18/Submit Section B/TourProject/doping_tibble.rds"))
tour_data <- as.tibble(readRDS("~/Mscs 264 F18/Submit Section B/TourProject/tour_data.rds"))
mergedtop_tens<- as.tibble(readRDS("~/Mscs 264 F18/Submit Section B/TourProject/mergedtop_tens.rds"))

```



```{r , echo=FALSE}
inputPanel(
  checkboxInput("doped", label = "Exclude Doped Winners",FALSE)
)

renderPlot({ 
WorldData <- map_data('world')
WorldData %>% filter(region != "Antarctica") -> WorldData
WorldData <- fortify(WorldData)

a <-  if(input$doped){tour_data %>%
  left_join(doping_tibble, by = c("Cyclist" = "Name"))%>%
  filter(Status == "Never failed tests") %>%
  mutate(Country = ifelse(Country=="United States", "USA", Country))%>%
  mutate(Country = ifelse(Country=="United Kingdom", "UK", Country))%>%
  group_by(Country) %>%
  count()
  } else{
    tour_data %>%
  left_join(doping_tibble, by = c("Cyclist" = "Name"))%>%
  mutate(Country = ifelse(Country=="United States", "USA", Country))%>%
  mutate(Country = ifelse(Country=="United Kingdom", "UK", Country))%>%
  group_by(Country) %>%
  count()
  } 

ggplot()+
  geom_map(data=WorldData, map=WorldData,
                  aes(x=long, y=lat, group=group, map_id=region),
                  fill="white", colour="#7f7f7f", size=0.5)+
  geom_map(data=a, map=WorldData,
                  aes(fill=n, map_id=Country),
                  colour="#7f7f7f", size=0.5)+
  theme_void()+
  scale_fill_continuous(low="thistle2", high="darkred", 
                               guide="colorbar")+
  labs(fill="legend", title="Number of Winners by Country", x="", y="")
 
})
```




##Barplot of Top Ten

```{r, echo = FALSE}
inputPanel(
  checkboxGroupInput("x", label = "Status:",
    choices = c("Admitted, No Failed Tests" = "Admitted to doping without failed tests or sanction for the current race.",
                "Accused, No Failed Tests" = "Accused of doping without failed tests, sanction or admittance in their career.",
                "Failed Tests at Some Point" = "Failed tests for doping in another competition or out of competition at some point in their career.",
                 "Clean" = "Has never been: stripped of a title, failed tests or sanctioned for doping to date, with no known accusations.",
                "Sanctioned for Doping, No Failed Tests" = "Sanctioned for doping without failed tests at some point in their career.",
                "Stripped of Title" = "Stripped of title in the current race due to doping."),
    selected = "Admitted to doping without failed tests or sanction for the current race.")
)



renderPlot({
  mergedtop_tens %>%
    filter(Rank != 11,
           Notes2 %in% input$x) %>%
    ggplot() + 
      geom_bar(mapping = aes(x = Year, fill = Notes2), 
               position = "stack", stat = "count")+
    scale_y_continuous(breaks=seq(0,10,1)) +
    coord_cartesian(ylim= c(0,10),
                    xlim = c(1998,2015)) +
    theme_dark() +
    scale_fill_brewer(palette="RdYlBu") +
    labs(fill = "Status")
})
    
```


```{r, echo = FALSE}

inputPanel(
  sliderInput("slider1", label = h3("Year"), min = 1998, 
        max = 2015, value = c(1998, 2015), sep = ""),
  textInput("text", label = h3("Key Words"), value = "")
)

renderTable({ 
top_tens %>% 
  select(-Rider) %>%
  mutate(Time = str_replace(Time, "^[^\\+](.*)", "Winner"))%>%
  mutate(Notes = ifelse(is.na(.$Notes)," ", .$Notes))%>%
  filter(Notes %in% Notes[str_detect(.$Notes, input$text)]) %>%
  mutate(Year = parse_integer(Year)) %>%
  filter(Rank <= 10) %>%
  filter(Year >= input$slider1[1], Year <= input$slider1[2]) %>%
  filter(Notes == str_subset(Notes, input$text))
}) 


```



